# 数据结构

## 线段树

### 两延迟标记

change0区间置0，change1区间加1，query询问区间和

```c++
struct Data
{
    int tag,tag0,sum;
}tree[40100];

void build(int l,int r,int x)
{
    tree[x].tag=-1;tree[x].sum=0;tree[x].tag0=0;
    if (l==r) return ;
    int mid=l+r>>1;
    build(l,mid,x<<1);build(mid+1,r,x<<1|1);
}

void Pushdown(int x,int l,int r)
{
    if (tree[x].tag==-1) return ;
    int mid=l+r>>1;
    if (tree[x].tag0==1)
    {
        tree[x<<1].tag0=1;
        tree[x<<1|1].tag0=1;
        tree[x<<1].tag=tree[x].tag;
        tree[x<<1|1].tag=tree[x].tag;
        tree[x<<1].sum=tree[x].tag*(mid-l+1);
        tree[x<<1|1].sum=tree[x].tag*(r-mid);
        tree[x].tag=-1;tree[x].tag0=0;
    }
    else
    {
        if (tree[x<<1].tag==-1) tree[x<<1].tag=tree[x].tag;
        else tree[x<<1].tag+=tree[x].tag;
        if (tree[x<<1|1].tag==-1) tree[x<<1|1].tag=tree[x].tag;
        else tree[x<<1|1].tag+=tree[x].tag;
        tree[x<<1].sum+=tree[x].tag*(mid-l+1);
        tree[x<<1|1].sum+=tree[x].tag*(r-mid);
        tree[x].tag=-1;
    }
}

void change0(int lq,int rq,int l,int r,int x)
{
    if (lq<=l&&rq>=r)
    {
        tree[x].tag=0;tree[x].sum=0;tree[x].tag0=1;
        return ;
    }
    Pushdown(x,l,r);
    int mid=l+r>>1;
    if (lq<=mid) change0(lq,rq,l,mid,x<<1);
    if (rq>mid) change0(lq,rq,mid+1,r,x<<1|1);
    tree[x].sum=tree[x<<1].sum+tree[x<<1|1].sum;
}

void change1(int lq,int rq,int l,int r,int x)
{
    if (lq<=l&&rq>=r)
    {
        if (tree[x].tag==-1) tree[x].tag=1;else tree[x].tag++;
        tree[x].sum+=r-l+1;
        return ;
    }
    Pushdown(x,l,r);
    int mid=l+r>>1;
    if (lq<=mid) change1(lq,rq,l,mid,x<<1);
    if (rq>mid) change1(lq,rq,mid+1,r,x<<1|1);
    tree[x].sum=tree[x<<1].sum+tree[x<<1|1].sum;
}

int query(int lq,int rq,int l,int r,int x)
{
    if (lq<=l&&rq>=r) return tree[x].sum;
    Pushdown(x,l,r);
    int mid=l+r>>1,ans=0;
    if (lq<=mid) ans+=query(lq,rq,l,mid,x<<1);
    if (rq>mid) ans+=query(lq,rq,mid+1,r,x<<1|1);
    tree[x].sum=tree[x<<1].sum+tree[x<<1|1].sum;
    return ans;
}
```